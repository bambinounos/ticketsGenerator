<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boleto N° {{ ticket.ticket_number }}</title>
    <!-- CDNs for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    {% include "raffles/includes/ticket_css.html" %}
</head>
<body>

    {% include "raffles/includes/ticket_card.html" with ticket=ticket raffle=raffle template=template %}

    <div class="controls">
        <button id="download-btn" class="btn">Descargar PDF</button>
        <!-- Optional: Back button -->
        <button onclick="window.history.back()" class="btn btn-secondary">Volver</button>
    </div>

    <script>
        window.jsPDF = window.jspdf.jsPDF;

        document.getElementById('download-btn').addEventListener('click', function() {
            const element = document.getElementById('ticket-{{ ticket.id }}');
            const btn = this;
            btn.innerHTML = 'Generando...';
            btn.disabled = true;

            // Wait a moment to ensure images are fully loaded/rendered
            setTimeout(() => {
                html2canvas(element, {
                    scale: 2, // Higher resolution
                    useCORS: true,
                    allowTaint: true,
                    logging: true,
                    backgroundColor: null, // Transparent if needed
                }).then(canvas => {
                    try {
                        const imgData = canvas.toDataURL('image/jpeg', 0.95);

                        // Create PDF (Landscape, unit: px, size: [800, 400])
                        const pdf = new jsPDF({
                            orientation: 'landscape',
                            unit: 'px',
                            format: [800, 400],
                            hotfixes: ['px_scaling']
                        });

                        pdf.addImage(imgData, 'JPEG', 0, 0, 800, 400);
                        pdf.save('Boleto_{{ ticket.ticket_number }}.pdf');
                    } catch (err) {
                        console.error("PDF Generation Error: ", err);
                        alert("Hubo un error generando el PDF. Por favor intente de nuevo.");
                    } finally {
                        btn.innerHTML = 'Descargar PDF';
                        btn.disabled = false;
                    }
                }).catch(err => {
                    console.error("Canvas Error: ", err);
                    alert("Error al capturar el boleto. Verifique que las imágenes carguen correctamente.");
                    btn.innerHTML = 'Descargar PDF';
                    btn.disabled = false;
                });
            }, 100);
        });
    </script>
</body>
</html>
