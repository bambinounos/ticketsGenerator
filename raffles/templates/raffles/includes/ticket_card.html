<div id="ticket-{{ ticket.id }}" class="ticket-container" style="
    background-color: {{ template.background_color|default:'#FFFFFF' }};
    color: {{ template.font_color|default:'#000000' }};
    {% if template.background_image %}
    background-image: url('{{ template.background_image.url }}');
    background-size: 100% 100%;
    background-repeat: no-repeat;
    {% endif %}
">
    <!-- Content overlaid on background -->
    <div class="ticket-content">
        <div class="ticket-main">
            <div class="header">
                <div style="display: flex; align-items: center; gap: 10px;">
                    {% if raffle.logo %}
                        <img src="{{ raffle.logo.url }}" style="height: 60px; object-fit: contain;">
                    {% endif %}
                    <div>
                        <h1>{{ raffle.name }}</h1>
                        {% if raffle.description %}
                        <p>{{ raffle.description|truncatechars:100 }}</p>
                        {% endif %}
                        {% if raffle.draw_datetime %}
                        <p style="margin-top: 5px; font-weight: bold;">Sorteo: {{ raffle.draw_datetime|date:"d/m/Y H:i" }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 10px; flex-grow: 1;">
                <div class="customer-info" style="flex: 1; min-width: 0;">
                    <p><strong>Nombre:</strong> {{ ticket.customer.first_name }}</p>
                    <p><strong>Teléfono:</strong> {{ ticket.customer.phone }}</p>
                    {% if ticket.customer.identification %}
                    <p><strong>ID:</strong> {{ ticket.customer.identification }}</p>
                    {% endif %}
                    <p><strong>Fecha Compra:</strong> {{ ticket.sold_at|date:"d/m/Y H:i" }}</p>
                </div>
                {% if raffle.product_images %}
                <div class="product-image" style="width: 150px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
                    <img src="{{ raffle.product_images.url }}" style="max-width: 100%; max-height: 140px; border-radius: 5px; object-fit: contain; background: rgba(255,255,255,0.5);">
                </div>
                {% endif %}
            </div>

            <!-- Social Links -->
            <div class="social-icons">
                {% for link in raffle.social_links_list.all %}
                    <a href="{{ link.url }}" target="_blank">
                        {% if link.icon %}
                            <img src="{{ link.icon.url }}" alt="{{ link.platform_name }}">
                        {% endif %}
                        <span>{{ link.platform_name }}</span>
                    </a>
                {% empty %}
                    <!-- Fallback for legacy text field if no social links objects exist -->
                    {% if raffle.social_links %}
                        <div style="background-color: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 8px;">
                            {{ raffle.social_links }}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="ticket-stub">
            <div class="ticket-number-display">N° {{ ticket.ticket_number }}</div>

            <div class="qr-code">
                <!-- Added crossOrigin="Anonymous" to try to fix taint issues -->
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data={{ request.scheme }}://{{ request.get_host }}{% url 'raffles:verify_ticket' ticket.qr_code %}"
                     alt="QR"
                     crossOrigin="Anonymous">
            </div>

            <p style="font-size: 9px; margin-top: 5px; background: rgba(255,255,255,0.8); word-break: break-all;">{{ ticket.qr_code }}</p>

            <div class="price-tag">${{ ticket.price }}</div>
        </div>
    </div>
</div>
